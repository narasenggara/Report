<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Suhu Gudang</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <h2>Laporan Suhu Gudang Cabang BDG016</h2>

  <!-- Opsi Upload -->
  <p><b>Pilih foto dari galeri:</b></p>
  <input type="file" id="upload" accept="image/*"><br><br>

  <!-- Opsi Kamera -->
  <p><b>Ambil foto langsung dari kamera:</b></p>
  <input type="file" id="camera" accept="image/*" capture="environment"><br><br>

  <img id="preview" width="300"><br><br>

  <textarea id="laporan" rows="6" cols="40" readonly></textarea><br><br>
  <button id="send">Kirim ke WhatsApp</button>

  <script>
    const preview = document.getElementById('preview');
    const laporan = document.getElementById('laporan');

    // Fungsi crop gambar
    function cropImage(img, x, y, w, h) {
      let canvas = document.createElement("canvas");
      let ctx = canvas.getContext("2d");
      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(img, x, y, w, h, 0, 0, w, h);
      return canvas;
    }

    async function processImage(img) {
      // Crop area suhu (posisi kira2, bisa diatur sesuai foto thermometer)
      let suhuCanvas = cropImage(img, 50, 60, 200, 60);  
      let rhCanvas   = cropImage(img, 50, 130, 200, 60); 

      // OCR suhu
      let suhuRes = await Tesseract.recognize(suhuCanvas, 'eng', {
        tessedit_char_whitelist: '0123456789.'
      });
      let suhu = suhuRes.data.text.replace(/[^0-9.]/g, "").trim();

      // OCR RH
      let rhRes = await Tesseract.recognize(rhCanvas, 'eng', {
        tessedit_char_whitelist: '0123456789'
      });
      let rh = rhRes.data.text.replace(/[^0-9]/g, "").trim();

      // Ambil jam dari timestamp foto (overlay kamera biasanya pojok bawah)
      let jamRes = await Tesseract.recognize(img, 'eng', {
        tessedit_char_whitelist: '0123456789:'
      });
      let jam = jamRes.data.text.match(/\b\d{1,2}[:.]\d{2}\b/);
      jam = jam ? jam[0].replace(".", ":") : "??:??";

      // Tanggal otomatis hari ini
      let now = new Date();
      let dd = String(now.getDate()).padStart(2, '0');
      let mm = String(now.getMonth() + 1).padStart(2, '0');
      let yy = String(now.getFullYear()).slice(-2);

      // Susun laporan
      let laporanTxt = 
        `Laporan suhu gudang cabang BDG016 (tanggal ${dd}/${mm}/${yy})\n` +
        `JAM : ${jam}\n` +
        `IN : ${suhu || "??"}\n` +
        `RH : ${rh || "??"}`;

      laporan.value = laporanTxt;
      navigator.clipboard.writeText(laporanTxt);
    }

    function handleFile(file) {
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        preview.src = img.src;
        processImage(img);
      };
      img.src = URL.createObjectURL(file);
    }

    document.getElementById('upload').addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    document.getElementById('camera').addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    document.getElementById('send').addEventListener('click', () => {
      let text = encodeURIComponent(laporan.value);
      window.open("https://wa.me/?text=" + text, "_blank");
    });
  </script>
</body>
</html>
