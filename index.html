<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Suhu Gudang</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <h2>Laporan Suhu Gudang Cabang BDG016</h2>

  <!-- Opsi Upload -->
  <p><b>Pilih foto dari galeri:</b></p>
  <input type="file" id="upload" accept="image/*"><br><br>

  <!-- Opsi Kamera -->
  <p><b>Ambil foto langsung dari kamera:</b></p>
  <input type="file" id="camera" accept="image/*" capture="environment"><br><br>

  <img id="preview" width="250"><br><br>

  <textarea id="laporan" rows="6" cols="40" readonly></textarea><br><br>
  <button id="send">Kirim ke WhatsApp</button>

  <script>
    const preview = document.getElementById('preview');
    const laporan = document.getElementById('laporan');

    function parseOCR(text) {
      console.log("OCR Raw:", text);

      // Cari jam (format hh:mm atau h:mm)
      let jam = text.match(/\b\d{1,2}[:.]\d{2}\b/);

      // Cari suhu (format xx.x)
      let suhu = text.match(/\b\d{2}\.\d\b/);

      // Cari RH (angka diikuti % atau RH)
      let rh = text.match(/\b\d{2,3}(?=\s*%|\s*RH)/);

      // Tanggal otomatis hari ini
      let now = new Date();
      let dd = String(now.getDate()).padStart(2, '0');
      let mm = String(now.getMonth() + 1).padStart(2, '0');
      let yy = String(now.getFullYear()).slice(-2);

      let laporanTxt = 
        `Laporan suhu gudang cabang BDG016 (tanggal ${dd}/${mm}/${yy})\n` +
        `JAM : ${jam ? jam[0].replace(".",":") : "??:??"}\n` +
        `IN : ${suhu ? suhu[0] : "??"}\n` +
        `RH : ${rh ? rh[0] : "??"}`;

      laporan.value = laporanTxt;
      navigator.clipboard.writeText(laporanTxt);
    }

    function handleFile(file) {
      if (!file) return;
      preview.src = URL.createObjectURL(file);

      Tesseract.recognize(file, 'eng', {
        tessedit_char_whitelist: '0123456789:.%RH',
        logger: m => console.log(m)
      }).then(({ data: { text } }) => {
        parseOCR(text);
      });
    }

    // Event Upload
    document.getElementById('upload').addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    // Event Kamera
    document.getElementById('camera').addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    // Tombol Kirim WhatsApp
    document.getElementById('send').addEventListener('click', () => {
      let text = encodeURIComponent(laporan.value);
      window.open("https://wa.me/?text=" + text, "_blank");
    });
  </script>
</body>
</html>
